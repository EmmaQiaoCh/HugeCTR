# SOK DLRM Benchmark

This is the SOK DLRM benchmark on Criteo Terabyte dataset.

## Prepare Dataset

### Use Criteo Terabyte Preprocessed by HugeCTR

```bash
git clone https://github.com/NVIDIA-Merlin/HugeCTR.git
cd HugeCTR/
cd sparse_operation_kit/documents/tutorials/DLRM_Benchmark/
# train_data.bin and test_data.bin is the binary dataset generated by hugectr
# $DATA is the target directory to save the splited dataset
python3 split_bin.py train_data.bin $DATA/train
python3 split_bin.py test_data.bin $DATA/test
```

### Use Synthetic Dataset

* Step 1, start the hugectr container
```
docker run --privileged=true --gpus=all -it --rm -v $YourDataDir:/home/workspace nvcr.io/nvidia/merlin/merlin-training:22.04
cd /home/workspace
```

* Step2, run the following script to generate a synthetic dataset, you can modify `num_samples` and `eval_num_samples` as you want.

```python
# python
import hugectr
from hugectr.tools import DataGenerator, DataGeneratorParams

data_generator_params = DataGeneratorParams(
  format = hugectr.DataReaderType_t.Raw,
  label_dim = 1,
  dense_dim = 13,
  num_slot = 26,
  i64_input_key = False,
  source = "./dlrm_raw/train_data.bin",
  eval_source = "./dlrm_raw/test_data.bin",
  slot_size_array = [203931, 18598, 14092, 7012, 18977, 4, 6385, 1245, 49, 186213, 71328, 67288, 11, 2168, 7338, 61, 4, 932, 15, 204515, 141526, 199433, 60919, 9137, 71, 34],
  nnz_array = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
  num_samples = 5242880,
  eval_num_samples = 1310720
)
data_generator = DataGenerator(data_generator_params)
data_generator.generate()
```

* Step 3, split the binary file

Note: the `--slot_size_array` should be the same as the slot_size_array in step 2.

```bash
git clone https://github.com/NVIDIA-Merlin/HugeCTR.git

python3 HugeCTR/sparse_operation_kit/documents/tutorials/DLRM_Benchmark/preprocess/split_bin.py dlrm_raw/train_data.bin ./splited_dataset/train/ --slot_size_array="[203931,18598,14092,7012,18977,4,6385,1245,49,186213,71328,67288,11,2168,7338,61,4,932,15,204515,141526,199433,60919,9137,71,34]"

python3 HugeCTR/sparse_operation_kit/documents/tutorials/DLRM_Benchmark/preprocess/split_bin.py dlrm_raw/test_data.bin ./splited_dataset/test/ --slot_size_array="[203931,18598,14092,7012,18977,4,6385,1245,49,186213,71328,67288,11,2168,7338,61,4,932,15,204515,141526,199433,60919,9137,71,34]"
```

## Environment

```bash
docker run --privileged=true --gpus=all -it --rm -v $YourDataDir:/home/workspace nvcr.io/nvidia/tensorflow:22.04-tf2-py3

# Install the latest SOK
git clone https://github.com/NVIDIA-Merlin/HugeCTR.git
cd HugeCTR/
cd sparse_operation_kit/
python3 setup.py build
cp -r build/lib.linux-x86_64-3.8/sparse_operation_kit/ /usr/local/lib/python3.8/dist-packages/

# Install custom interact op, you can skip this part if you don't want to use it
git clone https://github.com/NVIDIA/DeepLearningExamples.git
cd DeepLearningExamples/TensorFlow2/Recommendation/DLRM/tensorflow-dot-based-interact/
make
./build_pip_pkg.sh
pip install artifacts/tensorflow_dot_based_interact-0.0.1-cp38-cp38-linux_x86_64.whl
```

## Run Benchmark

Note: The custom interact op can be seen in [here](https://github.com/NVIDIA/DeepLearningExamples/tree/master/TensorFlow2/Recommendation/DLRM/tensorflow-dot-based-interact). If you don't install custom interact op, the `--custom_interact` should be removed from the instructions below.

```bash
cd HugeCTR/sparse_operation_kit/documents/tutorials/DLRM_Benchmark/

# FP32 Result with global batch size = 65536
# Note that --lr=24 is tested on real criteo dataset. This learning rate is too large for a synthetic dataset and it is likely to cause the loss to become nan
horovodrun -np 8 ./hvd_wrapper.sh python3 main.py --data_dir=/home/workspace/splited_dataset/ --global_batch_size=65536 --xla --compress --custom_interact --eval_in_last --epochs=1000 --lr=24

# AMP result with global batch size = 65536
horovodrun -np 8 ./hvd_wrapper.sh python3 main.py --data_dir=/home/workspace/splited_dataset/ --global_batch_size=65536 --xla --amp --custom_interact --eval_in_last --epochs=1000 --lr=24

# FP32 Result with global batch size = 55296
horovodrun -np 8 ./hvd_wrapper.sh python3 main.py --data_dir=/home/workspace/splited_dataset/ --global_batch_size=55296 --xla --compress --custom_interact --epochs=1000 --lr=24

# AMP result with global batch size = 55296
horovodrun -np 8 ./hvd_wrapper.sh python3 main.py --data_dir=/home/workspace/splited_dataset/ --global_batch_size=55296 --xla --amp --custom_interact --epochs=1000 --lr=24
```

## Performance

8 x A100 (82GB embedding table):
| batch size | exit criteria | frequent of evaluation | xla | custom interact | amp | compress | training time (minutes) | evaluating time (minutes) | total time (minutes) | average time of iteration (ms) | throughput(samples/second) |
| :---: | :---:        | :---:            | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---:  |
| 65536 | 1 epoch      | at end           | yes   | yes   | no    | yes   | 5.93  | 0.09  | 6.02  | 5.55  | 12.08M |
| 65536 | 1 epoch      | at end           | yes   | yes   | yes   | no    | 5.06  | 0.07  | 5.13  | 4.74  | 14.51M |
| 55296 | AUC > 0.8025 | every 3793 steps | yes   | yes   | no    | yes   | 5.23  | 1.44  | 6.67  | 4.87  | 11.66M |
| 55296 | AUC > 0.8025 | every 3793 steps | yes   | yes   | yes   | no    | 4.99  | 1.26  | 6.25  | 4.64  | 12.50M |

8 x V100 (82GB embedding table):
| batch size | exit criteria | frequent of evaluation | xla | custom interact | amp | compress | training time (minutes) | evaluating time (minutes) | total time (minutes) | average time of iteration (ms) | throughput(samples/second) |
| :---: | :---:        | :---:            | :---: | :---: | :---: | :---: | :---:  | :---: | :---:  | :---:  | :---: |
| 65536 | 1 epoch      | at end           | yes   | yes   | no    | yes   | 17.52  | 0.19  | 17.71  | 16.42  | 4.02M |
| 65536 | 1 epoch      | at end           | yes   | yes   | yes   | no    | 10.20  | 0.15  | 10.35  | 9.56   | 6.99M |
| 55296 | AUC > 0.8025 | every 3793 steps | yes   | yes   | no    | yes   | 16.45  | 3.59  | 20.04  | 14.45  | 3.85M |
| 55296 | AUC > 0.8025 | every 3793 steps | yes   | yes   | yes   | no    | 9.69   | 2.54  | 12.23  | 8.52   | 6.62M |

## Profile

```bash
cd hugectr/sparse_operation_kit/documents/tutorials/DLRM_Benchmark/
nsys profile --sample=none --backtrace=none --cudabacktrace=none --cpuctxsw=none --trace-fork-before-exec=true horovodrun -np 8 ./hvd_wrapper.sh python3 main.py --data_dir=($DATA) --global_batch_size=65536 --xla --compress --custom_interact --early_stop=30
```
